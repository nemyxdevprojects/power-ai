<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Power AI - Admin</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0e0e0e; color: #fff; height: 100vh; display: flex; justify-content: center; align-items: center; }

/* login screen */
#loginScreen { width: 360px; padding: 26px; background: #1a1a1a; border-radius: 14px; box-shadow: 0 0 24px rgba(0,0,0,0.7); text-align: center; }
#loginScreen h2 { margin-bottom: 12px; }
#loginScreen input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: none; background: #222; color: #fff; }
#loginScreen button { padding: 11px 18px; border-radius: 10px; border: none; background: linear-gradient(90deg,#6a11cb,#2575fc); color: #fff; font-weight: 600; cursor: pointer; }
#loginScreen .hint { margin-top:8px; font-size:13px; color:#bbb; }

/* main panel (hidden until login ok) */
#mainPanel { display: none; height: 92vh; width: 94vw; max-width: 1200px; display: flex; background: #121212; border-radius: 12px; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.7); }
#sidebar { width: 300px; background: #151515; padding: 14px; overflow-y: auto; border-right: 1px solid #222; }
.userItem { padding: 10px; margin-bottom: 8px; border-radius: 10px; background: #1e1e1e; cursor: pointer; transition: 0.15s; color:#ddd; }
.userItem.active { background: #2575fc; color: #fff; box-shadow: inset 0 0 8px rgba(0,0,0,0.4); }
.userItem:hover { transform: translateY(-1px); background: #2a2a2a; }
#chat { flex: 1; display: flex; flex-direction: column; }
#header { height: 64px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; background: linear-gradient(90deg,#6a11cb,#2575fc); color:#fff; }
#messages { flex: 1; padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }
.msg { padding: 10px 14px; border-radius: 14px; max-width: 72%; word-wrap: break-word; box-shadow: 0 2px 10px rgba(0,0,0,0.4); }
.user { background: #2575fc; align-self: flex-start; color: #fff; }
.admin { background: #222; align-self: flex-end; color: #fff; }
#inputZone { display: flex; gap: 10px; padding: 12px; background: #0f0f0f; border-top: 1px solid #222; }
#inputZone input { flex: 1; padding: 12px; border-radius: 10px; border: none; background: #222; color: #fff; }
#inputZone button { padding: 10px 16px; border-radius: 10px; border: none; background: linear-gradient(90deg,#6a11cb,#2575fc); color: #fff; cursor: pointer; font-weight:600; }
#inputZone button:active { transform: translateY(1px); }

/* small helpers */
#error { color: #ff6b6b; margin-top: 8px; font-size: 14px; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <h2>Power AI — Admin</h2>
  <input id="pwd" type="password" placeholder="Mot de passe" autocomplete="current-password" />
  <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
    <button id="btnLogin">Se connecter</button>
  </div>
  <div id="error" style="height:20px;margin-top:10px;"></div>
  <div class="hint">Le mot de passe est vérifié côté serveur — il n'est pas exposé ici.</div>
</div>

<!-- MAIN PANEL -->
<div id="mainPanel" aria-hidden="true">
  <div id="sidebar"></div>
  <div id="chat">
    <div id="header">Power AI — Admin</div>
    <div id="messages"></div>
    <div id="inputZone">
      <input id="adminMsg" type="text" placeholder="Réponds ici..." />
      <button id="btnSend">Envoyer</button>
    </div>
  </div>
</div>

<script>
/*
  admin.html client-side:
  - envoie le mot de passe via POST /admin/login (server.js doit gérer)
  - si ok -> serveur place cookie HttpOnly, on affiche le panel
  - ensuite on ouvre ws:// ou wss://.../admin pour recevoir nouvelles conversations
*/

// Helpers elements
const loginScreen = document.getElementById('loginScreen');
const mainPanel = document.getElementById('mainPanel');
const btnLogin = document.getElementById('btnLogin');
const pwdInput = document.getElementById('pwd');
const errorDiv = document.getElementById('error');

btnLogin.addEventListener('click', doLogin);
pwdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doLogin(); });

// Login: send password to server (no password stored here)
async function doLogin() {
  const pwd = pwdInput.value;
  errorDiv.textContent = '';
  if (!pwd) { errorDiv.textContent = 'Entre le mot de passe.'; return; }
  try {
    const res = await fetch('/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd })
    });
    if (res.ok) {
      // cookie HttpOnly posé par le serveur -> on peut maintenant afficher le panel
      showPanel();
    } else {
      const data = await res.json().catch(()=>({}));
      errorDiv.textContent = data.error || 'Mot de passe incorrect.';
    }
  } catch (err) {
    errorDiv.textContent = 'Erreur serveur.';
    console.error(err);
  }
}

// Show admin panel and init WS
function showPanel() {
  loginScreen.style.display = 'none';
  mainPanel.style.display = 'flex';
  mainPanel.setAttribute('aria-hidden','false');
  initAdminPanel();
}

// ADMIN PANEL logic (opens WebSocket to /admin)
function initAdminPanel(){
  // Use wss for HTTPS (render) or ws for local http. We'll try wss first, fallback to ws.
  const base = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${base}://${window.location.host}/admin`;
  const ws = new WebSocket(wsUrl);

  const sidebar = document.getElementById('sidebar');
  const messagesDiv = document.getElementById('messages');
  const adminMsgInput = document.getElementById('adminMsg');
  const btnSend = document.getElementById('btnSend');

  let conversations = {}; // { userId: [messages...] }
  let currentUser = null;

  // Render list of users
  function renderSidebar(){
    sidebar.innerHTML = '';
    const keys = Object.keys(conversations).sort((a,b)=> {
      // show most recent first (by last timestamp)
      const la = conversations[a].length ? conversations[a][conversations[a].length-1].timestamp : 0;
      const lb = conversations[b].length ? conversations[b][conversations[b].length-1].timestamp : 0;
      return lb - la;
    });
    keys.forEach(userId=>{
      const div = document.createElement('div');
      div.className = 'userItem' + (userId === currentUser ? ' active' : '');
      // show partial id and count
      const count = conversations[userId] ? conversations[userId].length : 0;
      div.textContent = `${userId.substring(0,8)}… (${count})`;
      div.onclick = ()=> { currentUser = userId; renderMessages(); renderSidebar(); };
      sidebar.appendChild(div);
    });
  }

  // Render messages for current user
  function renderMessages(){
    messagesDiv.innerHTML = '';
    if (!currentUser) return;
    (conversations[currentUser] || []).forEach(m=>{
      const el = document.createElement('div');
      el.className = 'msg ' + m.sender;
      el.textContent = m.text;
      messagesDiv.appendChild(el);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  ws.onopen = () => {
    console.log('WS admin connected', wsUrl);
  };

  ws.onmessage = (ev) => {
    let data;
    try { data = JSON.parse(ev.data); } catch(e){ return; }
    if (data.type === 'init') {
      conversations = data.conversations || {};
      renderSidebar();
    } else if (data.type === 'new_message') {
      const { userId, message } = data;
      if (!conversations[userId]) conversations[userId] = [];
      conversations[userId].push(message);
      renderSidebar();
      // if currently viewing that user, update messages
      if (userId === currentUser) renderMessages();
      // else you can also flash / highlight the user item (left as improvement)
    }
  };

  ws.onclose = () => {
    console.log('WS admin disconnected');
    // optional: try reconnect after delay
    setTimeout(()=>initAdminPanel(), 2000);
  };

  // send reply
  btnSend.addEventListener('click', () => {
    sendReply();
  });
  adminMsgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendReply(); });

  function sendReply(){
    const text = adminMsgInput.value.trim();
    if (!text || !currentUser) return;
    const payload = { type: 'reply', userId: currentUser, text };
    try {
      ws.send(JSON.stringify(payload));
      // optimistic update
      conversations[currentUser].push({ sender: 'admin', text, timestamp: Date.now() });
      renderMessages();
      adminMsgInput.value = '';
    } catch (e) {
      console.error('WS send failed', e);
    }
  }
}
</script>
</body>
</html>
